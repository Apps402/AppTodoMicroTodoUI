name: "Micro ToDo UI Image"

on: workflow_dispatch


permissions:
  id-token: write
  contents: read

jobs:
  BuildImage:
    runs-on: self-hosted
    env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        ARM_USE_OIDC: true
        IMAGE_NAME: appsmicrotodo-ui
        IMAGE_TAG: v1
        ACR_NAME: appsacrrrrrr
        ACR_LOGIN_SERVER: appsacrrrrrr.azurecr.io
        

    steps:
      - name: Checkout code
        uses: actions/checkout@v3


      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          


      - name: Get ACR Access Token
        id: acr-token
        run: |
          TOKEN=$(az acr login -n $ACR_NAME --expose-token --output tsv --query accessToken)
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Docker login to ACR using SP token
        run: |
          echo $TOKEN | docker login $ACR_LOGIN_SERVER \
            --username 00000000-0000-0000-0000-000000000000 \
            --password-stdin

      - name: Build Docker Image
        run: sudo docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Tag Docker Image for ACR
        run: docker tag $IMAGE_NAME:$IMAGE_TAG $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG

      - name: Push Docker Image to ACR
        run: docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG


    


